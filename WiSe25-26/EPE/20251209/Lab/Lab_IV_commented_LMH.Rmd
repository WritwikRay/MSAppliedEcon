---
title: "Lab Session: Instrumental Variables"
author: "Cristian Huse"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Converted to R in May/October 2021 using RStudio Version 1.4.1106

```

# Introduction

This lab session is about **Instrumental Variables (IV)**. The structure of the session is as follows:

* Preparation;
  + Load libraries, setwd, load data (.dta format)

* Example 5. "Intent-to-Treat" (ITT) Estimates

* Example 6. "Local Average Treatment Effect" (LATE) 2SLS IV Estimates

* Example 7. 2SLS IV Estimates for Randomized Promotion

Recall that there are different libraries one could use to perform IV estimation.



# Preparation

```{r, echo=F}

##Install packages (I attempted to list all packages needed in the basic lab sessions)
#install.packages("AER")
#install.packages("clubSandwich")
#install.packages("compositions")
#install.packages("fixest")
#install.packages("haven")
#install.packages("MatchIt")
#install.packages("Matching")
#install.packages("modelsummary")
#install.packages("optmatch")
#install.packages("panelr")
#install.packages("plm")
#install.packages("stargazer")
#install.packages("tidyverse")
#install.packages("tidyr")

```

```{r, message=F}
## Initialize ####
#Load libraries
library(AER) #for ivreg
library(fixest) #for feols etc
library(haven) #for read_dta
library(modelsummary) #for neat tables
library(tidyverse)

```

```{r}
rm(list=ls())
## Set working directory
#Specify the access path to the computer folder you will use for the analysis
#setwd("INSERT PATH OF FOLDER WHERE YOU SAVED THE DATASET WITH / or\\")

current_rmd <- rstudioapi::getSourceEditorContext()$path

# Set the working directory to the location of the R Markdown file
setwd(dirname(current_rmd))

## open data
#Open the cleaned data set
#set path for data
evaluation <- file.path(getwd(), "Data", "evaluation.dta")
#import .dta file
evaluation.df <- read_dta(evaluation)
#Select the relevant data
iv.df <- subset(evaluation.df, select = -eligible)

```



# Instrumental Variables

Most of our discussion so far has assumed that exposure/eligibility implies participation in a programme and that one can identify who is eligible within the sample, be it treatment or control group participants. In regression terms, this amounts to estimating the following regression

$$ Y_i = \alpha + \delta P_i + \gamma X_i + \varepsilon_i $$
where $Y_i$ is the outcome, $P_i$ is programme participation, $X_i$ are characteristics of individual $i$, and $\varepsilon_i$ is a random error term. 
Under the above assumptions and randomizing participation, the estimate of $\delta$ from this regression provides the ATE of the programme under study.

In real life, however, one often faces non-compliance, which appears in the form of namely non-compliance in the treatment group (e.g., refuses training or vaccination if that is the treatment) or non-compliance in the control group (e.g., gets training or vaccination when wasn't supposed to be treated).

Whenever one cannot assume full compliance, a distinction arises between **ITT (Intention to Treat)** and **LATE (Local Average Treatment Effects)**. Under full compliance, these two estimates are equivalent to the average treatment effect (ATE). However, in the presence of non-compliance, they are different and are closely related.

# Example 5. “Intent-to-Treat” (ITT) Estimates

Here, we assume that randomization is done by randomly assigning villages to the treatment and control groups. Moreover, we assume that all households in treatment villages can participate in the programme, but only some of them decide to do so, i.e., non-compliance occurs in the treatment group in that some households offered the program do not take it up. Specifically, we assume that 59 percent of households participate, and 41 percent do not participate among participants in the treatment group. On the other hand, we assume full compliance on the control group, where no one participates in the program.

By estimating the regression above and ignoring non-compliance, the estimate for $\delta$ provides the ITT estimate. Using the HISP data, we focus on data post-programme (round = 1) and regress health expenditures on the treatment_locality indicator (which switches on if the household is in a treatment area, regardless of taking up the programme). 

The estimate for the regression coefficient ($\delta$) is $-6.41$, which documents how households in villages where HISP was offered spent on average $\$6.41$ less on health expenditures than households in villages where HISP was not offered. This is the ITT estimate for the impact of offering the program to the treatment group. 

```{r}
#You can estimate 'intent-to-treat estimates', i.e. program impact at the
#village-level irrespective of who takes up the program or not.

ex5_lm <- lm(health_expenditures ~ treatment_locality, round == 1, data = iv.df)

models <- list("ex5_lm" = ex5_lm)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo|F")

```



**Note that the ITT estimate ($\delta_{ITT}$) was in reality generated by only 59 percent of the treated households, so the "true" effect ($\delta_{LATE}$) should be larger, i.e., $\delta_{ITT}$ provides a lower bound for $\delta_{LATE}$.** Alternatively, the estimate of $-6.41$ is a weighted average of outcomes among the 59 percent of households that participated in the program and the 41 percent of households that chose not to participate in the program, $\delta_{ITT}=Prob(take-up) \times \delta_{LATE} + (1-Prob(take-up)) \times 0$.

To obtain the “local average treatment effect” $(\delta_{LATE})$, you need to scale the ITT estimate $(\delta_{ITT})$ by the share of effectively treated individuals (compliers), thus

$$ \delta_{ITT} = Prob(take-up)\times\delta_{LATE} $$
which amounts to $\delta_{LATE}=(-6.406/0.59)=-10.86$.

That is, under non-compliance, LATE estimates the average impact of the program if it was estimated on the groups actually participating in the programme. 



# Instrumental Variables, Local Average Treatment Effects, and Imperfect Compliance

Under non-compliance, the decision to participate becomes endogenous and $\delta$ does not provide an estimate of the ATE when estimating the regression equation

$$ Y_i = \alpha + \delta P_i + \gamma X_i + \varepsilon_i $$

One can, however, obtain an estimate of the ATE (rather LATE) by obtaining an instrument for program participation. With such instrumental variable, one can estimate a predictive regression for participation (first-stage) and the estimates of treatment ($\hat{P}_i$) are used in the second-stage to estimate the effect of the programme. Formally,

$$ P_i = \gamma_0 + \gamma_1 X_i + \gamma_2 Z_i + \upsilon_i $$
Note that the exogenous variables $X_i$ are included, in addition to a new set of variables denoted by $Z_i$. These are exactly the instrumental variables, which should satisfy

1. $Cov(Z_i,P_i)\ne0$. In words, the instrumental variable affects the chance of an individual being offered the program to actually participate in the program. For an instrument to be valid, the correlation between the instrumental variable and program participation needs to be large. Instruments that are only weakly correlated are not appropriate.

2. $Cov(Z_i, \varepsilon_i)=0$. There is no correlation between the instrumental variable and the outcome of interest, apart from its effect on the probability to participate in the program.

If such an instrument exists, the LATE estimate can be obtained through using the 2SLS estimator, with stage 1 being estimated using the regression above and stage 2 being estimated as follows

$$ Y_i = \alpha + \delta_{LATE} \hat{P}_i + \gamma X_i + \varepsilon_i $$

with $\hat{P}_i$ being the predicted values from the first stage (since it is estimated rather than observed, standard errors need to be corrected). 



# Example 6. "Local Average Treatment Effect" (Late) 2SLS IV estimates

In this example, the instrumental variable (treatment_locality) is an indicator of whether HISP was randomly offered to households in a given locality. 

In the first-stage regression, a variable capturing whether a household was enrolled or not in the program is regressed on the randomization dummy (treatment_locality). The coefficient, 0.598 indicates that approximately 59.8% of households enrolled in HISP when the program was offered in their locality. 

The second-stage regression uses the predicted enrollment from the first stage as a regressor to explain variation in the outcomes of interest. The estimated coefficient for $\delta_{LATE}$ suggests that participation in the HISP program lowers health expenditures by $\$10.71$. Rouding issues aside, this is the same number obtained by multiplying the ITT estimate by the share of units enrolled in the treatment group.

```{r}
ex6_iv <- ivreg(health_expenditures ~ enrolled | treatment_locality, 
                data = subset(iv.df, round == 1))
summary(ex6_iv)
models <- list("ex6_iv" = ex6_iv)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo|F")

```



While we are unable to focus much time on it, there is an important literature on instruments, instrument validity, and "instrument strength". Intuitively, one would like to have an instrument which has explanatory power in what regards the endogenous variable and that the first-stage regression as a whole "makes sense". Running the first stage separately shows us that the F-statistic is quite high and that the coefficient associated to the instrument is statistically significant, implying that the conditional correlation between endogenous variable and instrument is -- at least -- not low.

```{r}
 #display first-stage (manually)
ex6_iv_s1 <- lm(enrolled ~ treatment_locality, data = subset(iv.df, round == 1))

models <- list("ex6_iv_s1" = ex6_iv_s1)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo")

```



# Instrumental Variables and Randomized Promotion

One way to encourage take-up of a programme is via its randomized promotion, e.g., an information campaign ("vaccines work") or other types of encouragement that can increase program take-up ("get a lottery ticket upon vaccination").

When randomized promotion is used, the strategy is to generate a valid instrumental variable that is correlated with program participation, but uncorrelated with the outcome of interest, aside from its effect through participation. Therefore, the same two-stage strategy described above can be used:

1. Isolate the effect of randomized promotion on program participation;

2. We regress the outcome on the predicted value of program take-up from the first stage.

To implement this using the HISP data, assume that HISP is offered universally throughout the country, i.e., it is not randomized. However, assume that a randomized promotion campaign is undertaken in a sub-sample of villages. Such campaign is an
instrument  satisfying 1-2 above, i.e., it aims to increase enrollment in HISP and it does not directly affect the outcome indicator of interest (health expenditures).



# Example 7. 2SLS IV Estimates for Randomized Promotion

With an instrumental variable created by randomized promotion, the LATE estimate can be obtained through 2SLS. The first stage identifies the effects of the promotion activities on program take-up, in this case, by 40.8 percent. 

The second stage shows a reduction in the range $\$9.50-9.75$ in health expenditures.

```{r}
#Check objects in data.frame -- note *.*_rp variables
objects(evaluation.df)

#Select the relevant data, drop what not needed
rp.df <- subset(evaluation.df, select = c(-eligible, -treatment_locality, -enrolled))

#second-stage 
ex7_iv <- ivreg(health_expenditures ~ enrolled_rp | promotion_locality, 
                data = subset(rp.df, round == 1))

models <- list("ex7_iv" = ex7_iv)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo")

#display first stage
ex7_iv_s1 <- lm(enrolled_rp ~ promotion_locality, data = subset(rp.df, round == 1))

models <- list("ex7_iv_s1" = ex7_iv_s1)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo")

#you could also use a multivariate regression
#note: exogenous regressors have to be included as instruments for themselves
ex7_mv <- ivreg(health_expenditures ~ enrolled_rp + age_hh + age_sp + 
                  educ_hh + educ_sp + female_hh + indigenous + 
                  hhsize + dirtfloor + bathroom + land + hospital_distance |
                  promotion_locality + age_hh + age_sp + educ_hh + educ_sp + 
                  female_hh + indigenous + hhsize + dirtfloor + bathroom + land +
                  hospital_distance, 
                data = subset(rp.df, round == 1))

models <- list("ex7_mv" = ex7_mv)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo")

#first stage
ex7_mv_s1 <- lm(enrolled_rp ~ promotion_locality + 
                  age_hh + age_sp + educ_hh + educ_sp + female_hh + 
                  indigenous + hhsize + dirtfloor + bathroom + land + hospital_distance, 
                data = subset(rp.df, round == 1))

models <- list("ex7_mv_s1" = ex7_mv_s1)
modelsummary(models, 
             vcov = ~ locality_identifier, 
             stars = c("*" = .1, "**" = .05, "***" = .01), 
             fmt = 3, 
             gof_omit = "AIC|BIC|Log.Lik.|R2 Adj.|R2 Within|R2 Pseudo")

```
1. Why would one use IV within the context of programme evaluation?
Assumption of full compliance: units that are assigned to the treatment and control groups fully comply with their assignment
But it’s often unrealistic in real life:
•	Some programs allow potential participants to choose to enroll and thus are not able to exclude potential participants who want to enroll
•	Not enough big budgets that supply a sample that represents the eligible population.
o	When we have full compliance then we will have ATE (TGs and CGs)
o	But individual assigned to TG choose not to participate
o	Individual assigned to the CG manage to participate in the program  
	Solution: IV

2. Explain the concepts of ITT (intention-to-treat) and TOT (treatment-on-the-treated). Under which conditions do they coincide – explain why.
ITT: compares outcomes of groups to whom treatment has randomly been offered (treatment) vs. non-offered (control), regardless of whether or not those in the treatment group actually enroll in the program
TOT: measures the impact of a program for the group of individuals who are offered the program and actually participate

Under full compliance the two coincide, now all people who are offered the program actually participate in the program (treatment group sample is intact and valid)

3. Explain the problems of generating an instrument ex post. within the context of programme evaluation.
* searching for an IV ex post is both hard and risky, because we don't want the IV to be affected by the outcome of the study (in a good RCT, only the outcome changes) . So better to do it ex-ante

4. Explain the instrument of randomized promotion. Make sure to mention the key issues to keep in mind in its implementation.
•	It is an instrument that influences the likelihood of participating in a program.
o	It should  be ex ante:
  	Randomized promotion 
    •	It randomly assigns promotion or encouragement of people to participate in the program. 
    •	It leads to valid estimates of the counterfactual if the promotion campaign substantially increases the take-up of the program without directly affecting the outcomes of the interest.
	It is used to correct the non-compliance to a program

5. Why would the IV strategy yield LATE but not ATE?
IV is a local effect, because 
- IV methods identify the average gain to persons induced to change their choice by a change of the instrument (referred to as compliers)
- however we cannot identify who these people are ("local average treatment effect" or LATE)
- Different instruments will identify different parameters and answer different questions (if the instrument is randomized promotion, the LATE will be the effect of the program on those who would not have participated without the promotion, if the instrument is a lottery, the LATE will be the effect of the program on those who would not have participated without the lottery)
- Caution in extrapolating to the whole population (as the effect is local)

# References

Gertler, Paul J.; Martinez, Sebastian; Premand, Patrick; Rawlings, Laura
B.; Vermeersch, Christel M. J. (2016). Impact Evaluation in Practice, Second Edition, Technical Companion (Version 1.0). Washington, DC: Inter-American Development Bank and World Bank.
